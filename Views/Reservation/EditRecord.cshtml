@using ReservationSystem.Util
@using ReservationSystem.ViewModels
@model ReservationViewModel

@{
    ViewData["Title"] = "Edit Reservation";
}
<div class="text-center">
    <h1>@ViewData["Title"]</h1>
    <form asp-action="EditRecord" method="post">
        @Html.AntiForgeryToken()
        @Html.ValidationSummary(true, "", new { @class = "text-danger" })
        <input type="hidden" asp-for="Id" />
        <input type="hidden" asp-for="CreatedAt" />
        <input type="hidden" asp-for="ReservationItemId" />
        <div class="row">
            <div class="col-md-12">
                <fieldset>
                    <legend>Customer</legend>
                    <div class="mb-3">
                        <label class="form-label" asp-for="CustomerName"></label>
                        <input class="form-control" asp-for="CustomerName" readonly />
                        <span asp-validation-for="CustomerName" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" asp-for="CustomerEmail"></label>
                        <input class="form-control" asp-for="CustomerEmail" readonly />
                        <span asp-validation-for="CustomerEmail" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" asp-for="CustomerPhone"></label>
                        <input class="form-control" asp-for="CustomerPhone" readonly />
                        <span asp-validation-for="CustomerPhone" class="text-danger"></span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" asp-for="Note"></label>
                        <textarea class="form-control" asp-for="Note" readonly></textarea>
                    </div>

                </fieldset>
            </div>
            <div class="col-md-12">
                <fieldset>
                    <legend>Service</legend>
                    <p>Please select your service</p>
                    <div class="row" id="serviceItemContainer">
                        <div class="col-md-12">
                            <table class="table">
                                <thead>
                                    <tr class="trRow">
                                        <th scope="col"></th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Duration(min)</th>
                                        <th scope="col" style="padding-right:20px;">Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr class="trRow">
                                        <td><a id="resetService" class="icon-btn icon-btn-primary btn-delete-reader"><i class="fas fa-trash-alt"></i></a></td>
                                        <td id="serviceItemName">@Model.ReservationItemName</td>
                                        <td id="serviceItemDuration">@Model.ReservationItemDuration</td>
                                        <td id="serviceItemPrice" style="padding-right:20px;">@Model.ReservationItemPrice</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="row" id="serviceItemSelect">
                        <div class="col-md-12">
                            <table class="table">
                                <thead>
                                    <tr class="trRow">
                                        <th scope="col"></th>
                                        <th scope="col">Name</th>
                                        <th scope="col">Duration(min)</th>
                                        <th scope="col">Price</th>
                                        <th scope="col" style="padding-right:20px;">Description</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (Model.AvailableItems != null && Model.AvailableItems.Any())
                                    {
                                        foreach (var item in Model.AvailableItems)
                                        {
                                            <tr class="service-card trRow">
                                                <td class="card-id" data-id="@item.Id"><a class="icon-btn icon-btn-primary addItemBtn" data-id="@item.Id"><i class="fas fa-plus"></i></a></td>
                                                <td class="card-title">@item.ItemName</td>
                                                <td class="card-duration">@item.DurationMinutes (min)</td>
                                                <td class="card-price">@PriceUtil.GetPriceString(item.ItemPrice)</td>
                                                <td style="padding-right:20px;">
                                                    <button type="button"
                                                            class="icon-btn icon-btn-primary"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#descModal-@item.Id">
                                                        <i class="fas fa-info"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <!-- Modal -->
                                            <div class="modal fade" id="descModal-@item.Id" tabindex="-1" aria-hidden="true">
                                                <div class="modal-dialog">
                                                    <div class="modal-content">
                                                        <div class="modal-header">
                                                            <h5 class="modal-title">@item.ItemName</h5>
                                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                        </div>
                                                        <div class="modal-body">
                                                            @item.ItemDescription
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else
                                    {
                                        <tr>
                                            <td colspan="5" class="text-center">No services</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="col-md-12">
                        <label class="form-label" asp-for="ReservationAt"></label>
                        <input class="form-control" asp-for="ReservationAt" readonly />
                        <span asp-validation-for="ReservationAt" class="text-danger"></span>
                    </div>
                    <div class="col-md-12 mt-4">
                        <button type="button" id="selectDateTimeBtn" class="hero-btn hero-btn-primary">
                            Select Date & Time
                        </button>
                    </div>
                    <div class="col-md-12 mt-3" id="availableTimes">
                        
                    </div>
                </fieldset>
            </div>
        </div>
        <button type="submit" class="hero-btn hero-btn-primary">Submit</button>
        <a class="hero-btn hero-btn-primary" asp-action="GetRecords" asp-controller="Reservation">Back</a>
    </form>
</div>






<script>
    document.addEventListener("DOMContentLoaded", function () {
        const cards = document.querySelectorAll(".service-card");
        const addItemBtn = document.getElementById("addItemBtn");
        const hiddenInput = document.getElementById("ReservationItemId");
        const resetServiceBtn = document.getElementById("resetService");
        const serviceItemContainer = document.getElementById("serviceItemContainer");
        const serviceItemName = document.getElementById("serviceItemName");
        const serviceItemDescription = document.getElementById("serviceItemDescription");
        const serviceItemDuration = document.getElementById("serviceItemDuration");
        const serviceItemPrice = document.getElementById("serviceItemPrice");
        const addItemButtons = document.querySelectorAll(".addItemBtn");
        const serviceItemSelect = document.getElementById("serviceItemSelect");
        serviceItemSelect.classList.add("d-none");
        const AvailableTimesContainer = document.getElementById("availableTimes");
        AvailableTimesContainer.classList.add("d-none");
        const ReservationAt = document.getElementById("ReservationAt");
        addItemButtons.forEach(btn => {
            btn.addEventListener("click", (e) => {
                e.preventDefault();
                const card = btn.closest(".service-card");
                const id = btn.dataset.id;
                const name = card.querySelector(".card-title").innerText;
                const duration = card.querySelector(".card-duration").innerText;
                const price = card.querySelector(".card-price").innerText;
                const confirmed = confirm(`Are you sure you want this service: ${name}?`);

                if (confirmed) {
                    hiddenInput.value = id;
                    serviceItemContainer.classList.remove("d-none");
                    serviceItemName.innerText = name;
                    serviceItemDuration.innerText = duration;
                    serviceItemPrice.innerText = price;
                    serviceItemSelect.classList.add("d-none");
                    resetServiceBtn.classList.remove("d-none");
                }
            });
        });

        resetServiceBtn.addEventListener("click", function (e) {
            e.preventDefault();
            AvailableTimesContainer.classList.add("d-none");
            serviceItemSelect.classList.remove("d-none")
            serviceItemContainer.classList.add("d-none");
            hiddenInput.value = ""; // resetni hodnotu
            resetServiceBtn.classList.add("d-none");
            ReservationAt.value = ""
        });
        document.getElementById("selectDateTimeBtn").addEventListener("click", async () => {
            const duration = parseInt(serviceItemDuration.innerText);
            if (!hiddenInput.value || hiddenInput.value === "00000000-0000-0000-0000-000000000000") {
                alert("Please select a service first!");
                return; // ukončíme funkciu, fetch sa nespustí
            }
            if (!AvailableTimesContainer.classList.contains("d-none")) {
                AvailableTimesContainer.classList.add("d-none");
                return;
            }
            await loadAvailableTimes(duration);
        });
        async function loadAvailableTimes(duration) {
            const response = await fetch(`/api/reservationapi?duration=${duration}`);
            const data = await response.json();
            AvailableTimesContainer.classList.remove("d-none");
            AvailableTimesContainer.innerHTML = "";
            console.log(data);
            data.days.forEach(day => {
                const dayDiv = document.createElement("div");
                dayDiv.classList.add("day-block");

                const dateTitle = document.createElement("h5");
                dateTitle.textContent = day.date;
                dayDiv.appendChild(dateTitle);

                const timesDiv = document.createElement("div");
                day.times.forEach(time => {
                    const btn = document.createElement("button");
                    btn.textContent = time;
                    btn.classList.add("btn", "btn-outline-primary", "m-1");
                    btn.addEventListener("click", (e) => {
                        e.preventDefault();
                        const selectedDateTime = day.date + " " + time; // spojenie dátumu a času
                        const confirmedDateTime = confirm(`Are you sure with this date and time: ${selectedDateTime} ?`)
                        if(confirmedDateTime){
                            ReservationAt.value = selectedDateTime; // uloží do inputu
                            AvailableTimesContainer.classList.add("d-none");
                        }
                    });
                    timesDiv.appendChild(btn);
                });
                
                dayDiv.appendChild(timesDiv);
                AvailableTimesContainer.appendChild(dayDiv);
        });
    }
    });
</script>